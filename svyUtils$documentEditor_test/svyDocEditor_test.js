/**
 * @properties={typeid:24,uuid:"8160E8F3-F210-4D87-B744-7995FD47C2C8"}
 */
function setUp() {
	var sql = 'INSERT INTO public.customers(customerid, companyname, contactname, contacttitle, address, city, region, postalcode, country, phone, fax) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);'
	plugins.rawSQL.executeSQL('example_data', sql, ['SVYDO', 'SvyDocEditorCompany', 'Editor', 'Mr.', 'test address', 'test city', null, null, 'test country', null, null]);

	var sqlOrder = 'INSERT INTO public.orders(orderid, customerid, employeeid, orderdate, requireddate, shippeddate, shipvia, freight, shipname, shipaddress, shipcity, shipregion, shippostalcode, shipcountry) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);';
	plugins.rawSQL.executeSQL('example_data', sqlOrder, [999910, 'SVYDO', null, null, null, null, null, null, null, null, null, null, null, 'c1']);
	plugins.rawSQL.executeSQL('example_data', sqlOrder, [999911, 'SVYDO', null, null, null, null, null, null, null, null, null, null, null, 'c2']);

	var sqlLine = 'INSERT INTO public.order_details(orderid, productid, unitprice, quantity, discount) VALUES (?, ?, ?, ?, ?);';
	plugins.rawSQL.executeSQL('example_data', sqlLine, [999910, 8, 14, 12, 0]);
	plugins.rawSQL.executeSQL('example_data', sqlLine, [999910, 9, 14, 12, 0]);
	plugins.rawSQL.executeSQL('example_data', sqlLine, [999910, 10, 14, 12, 0]);
	plugins.rawSQL.executeSQL('example_data', sqlLine, [999911, 9, 14, 12, 0]);
	plugins.rawSQL.executeSQL('example_data', sqlLine, [999911, 10, 14, 12, 0]);

}

/**
 * @properties={typeid:24,uuid:"27DDCD56-1009-4D81-9B6E-200811106BCC"}
 */
function tearDown() {
	var clearSQL = 'delete from customers where customerid = ?';
	var clearOrderSQL = 'delete from orders where customerid = ?';
	var clearLineSQL = 'delete from order_details where orderid = ?';

	plugins.rawSQL.executeSQL('example_data', clearSQL, ['SVYDO']);
	plugins.rawSQL.executeSQL('example_data', clearOrderSQL, ['SVYDO']);
	plugins.rawSQL.executeSQL('example_data', clearLineSQL, [999910]);
	plugins.rawSQL.executeSQL('example_data', clearLineSQL, [999911]);

}

/**
 * @properties={typeid:24,uuid:"393D26BC-3C08-45EC-8FDF-A1A71AB79B11"}
 * @AllowToRunInFind
 */
function test_mergeIf() {

	var content = '<h2 style="text-align:center;"><span class="mention svy-mention" data-mention="#Customer ID" data-real-value="customerid" contenteditable="false" data-format="">#Customer ID</span>&nbsp;</h2><p style="text-align:center;">Informe de control de ciclo (<span class="mention svy-mention" data-mention="#Company" data-real-value="companyname" contenteditable="false" data-format="">#Company</span> )</p><p style="text-align:center;"><span class="mention svy-mention" data-mention="@if.NombreParejaPaciente" data-real-value="NombreParejaPaciente" contenteditable="false" data-format="">@if.NombreParejaPaciente</span>&nbsp;</p><p style="text-align:center;"><span class="mention svy-mention" data-mention="@endIf.NombreParejaPaciente" data-real-value="NombreParejaPaciente" contenteditable="false" data-format="">@endIf.NombreParejaPaciente</span>&nbsp;</p><p style="text-align:center;">Paciente:&nbsp;<strong> </strong><span class="mention svy-mention" data-mention="@if.NombreParejaPaciente" data-real-value="id_pareja" contenteditable="false" data-format="">@if.NombreParejaPaciente</span>&nbsp;</p><p style="text-align:center;">Pareja:&nbsp;<strong> </strong><span class="mention svy-mention" data-mention="@endIf.NombreParejaPaciente" data-real-value="id_pareja" contenteditable="false" data-format="">@endIf.NombreParejaPaciente</span>&nbsp;</p><p style="text-align:right;">Médico responsable: <strong><span class="mention svy-mention" data-mention="#Company" data-real-value="companyname" contenteditable="false" data-format="">#Company</span> &nbsp;</strong><span class="mention svy-mention" data-mention="@if.Coordinadora" data-real-value="tb_pro_tto_to_tb_persona.obtenerRespATP_cl" contenteditable="false" data-format="">@if.Coordinadora</span></p><p style="text-align:right;">Coordinadora: <span class="mention svy-mention" data-mention="@endIf.Coordinadora" data-real-value="tb_pro_tto_to_tb_persona.obtenerRespATP_cl" contenteditable="false" data-format="">@endIf.Coordinadora</span> &nbsp;</p><p style="text-align:justify;">Se está realizando el siguiente tratamiento: . Con las siguientes especificaciones: <span class="mention svy-mention" data-mention="@if.MedicacionPrevia" data-real-value="rs_tb_pro_tto_tb_estim_medicac_estim.nombre_comerc_lt" contenteditable="false" data-format="">@if.MedicacionPrevia</span>&nbsp;</p><h3 style="text-align:justify;">Medicación previa</h3><p style="text-align:justify;">Deberá tomar los siguientes medicamentos siguiendo las instrucciones dadas por su médico. No modifique ni suspenda ninguna medicación sin consultárselo previamente.</p><p style="text-align:justify;"><span class="mention svy-mention" data-mention="$startRepeater.Orders" data-real-value="startRepeater-customers_to_orders" contenteditable="false" data-format="">$startRepeater.Orders</span> &nbsp;</p><p style="text-align:justify;"><strong>NombreMedicamento: </strong>desde : InicioToma. Dosis: : Dosis. Vía: : Via <span class="mention svy-mention" data-mention="$endRepeater" data-real-value="endRepeater" contenteditable="false" data-format="">$endRepeater</span> <span class="mention svy-mention" data-mention="@endIf.MedicacionPrevia" data-real-value="rs_tb_pro_tto_tb_estim_medicac_estim.nombre_comerc_lt" contenteditable="false" data-format="">@endIf.MedicacionPrevia</span> <span class="mention svy-mention" data-mention="@if.TipoCiclo" data-real-value="t_ciclo_lt" contenteditable="false" data-format="">@if.TipoCiclo</span></p><p style="text-align:justify;">&nbsp;</p><p style="text-align:justify;">Paciente que acude a consulta para valoración ecográfica y realización de analítica hormonal dentro del protocolo de ciclo natural. Test de ovulación positivo el día <span style="color:#abb2bf;">_______________. <span class="mention svy-mention" data-mention="@endIf.TipoCiclo" data-real-value="t_ciclo_lt" contenteditable="false" data-format="">@endIf.TipoCiclo</span> <span class="mention svy-mention" data-mention="@if.MedicacionLargaDuracion" data-real-value="medicacion_lg" contenteditable="false" data-format="">@if.MedicacionLargaDuracion</span></span></p><h4><strong>Medicación larga duración</strong></h4><p>Deberá tomar los siguientes medicamentos siguiendo las instrucciones dadas por su médico. No modifique ni suspenda ninguna medicación sin consultárselo previamente.</p><figure class="table"><table><thead><tr><th style="background-color:hsl(0, 0%, 100%);text-align:center;">&nbsp;</th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Lunes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Martes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Miércoles</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Jueves</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Viernes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Sábado</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Domingo</strong></span></th></tr></thead><tbody><tr><td style="text-align:center;">&nbsp;</td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">21 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">22 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">23 &nbsp;mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">24 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">25 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">26 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">27 mar.</span></td></tr><tr><td style="background-color:#f8d8da;border-color:hsl(0, 0%, 0%);border-style:solid;text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td></tr><tr><td style="background-color:#f8d8da;border-color:hsl(0, 0%, 0%);border-style:solid;text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td></tr></tbody></table></figure><p><span class="mention svy-mention" data-mention="@endIf.MedicacionLargaDuracion" data-real-value="medicacion_lg" contenteditable="false" data-format="">@endIf.MedicacionLargaDuracion</span>&nbsp;</p><h4><strong>Calendario de medicación</strong></h4><p>Si el tratamiento sufre alguna modificación, su médico se lo especificará posteriormente.</p><p>La programación del ciclo es provisional, se fijará la fecha en función de la siguiente menstruación, normalmente se comienza el día 3º de ciclo, considerando el primer día de ciclo como primer día de menstruación normal</p><figure class="table"><table><tbody><tr><th style="background-color:#f8d8da;"><strong>Día tto.</strong></th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">Día&nbsp;</th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">&nbsp;</th><td>&nbsp;</td></tr></tbody></table></figure><p style="text-align:justify;">La administración de los medicamentos debe de realizarse todos los días a la misma hora, recomendamos la última hora de la tarde para que cuando comience con los controles sea tras los mismos. En el caso que se indique administraciones mañana y tarde debe de procurar que haya 12 horas de separación.</p><p style="text-align:justify;">&nbsp;</p><h4><strong>Control ecográfico <span class="mention svy-mention" data-mention="@if.OD" data-real-value="tb_pro_tto_to_tb_exp_mujer.d_antrales_in" contenteditable="false" data-format="">@if.OD</span>&nbsp;</strong></h4><p>Número y tamaño de los folículos del ovario derecho: : OD <span class="mention svy-mention" data-mention="@endIf.OD" data-real-value="tb_pro_tto_to_tb_exp_mujer.d_antrales_in" contenteditable="false" data-format="">@endIf.OD</span> <span class="mention svy-mention" data-mention="@if.OI" data-real-value="tb_pro_tto_to_tb_exp_mujer.i_antrales_in" contenteditable="false" data-format="">@if.OI</span>&nbsp;</p><p>Número y tamaño de los folículos del ovario izquierdo: : OI <span class="mention svy-mention" data-mention="@endIf.OI" data-real-value="tb_pro_tto_to_tb_exp_mujer.i_antrales_in" contenteditable="false" data-format="">@endIf.OI</span> <span class="mention svy-mention" data-mention="@if.GrosorEndometrio" data-real-value="tb_pro_tto_to_tb_exp_mujer.lin_endom_de" contenteditable="false" data-format="">@if.GrosorEndometrio</span>&nbsp;</p><p>Grosor endometrial: : GrosorEndometrial <span class="mention svy-mention" data-mention="@endIf.GrosorEndometrio" data-real-value="tb_pro_tto_to_tb_exp_mujer.lin_endom_de" contenteditable="false" data-format="">@endIf.GrosorEndometrio</span> <span class="mention svy-mention" data-mention="@if.Ecogenicidad" data-real-value="tb_pro_tto_to_tb_exp_mujer.ecogenici_lt" contenteditable="false" data-format="">@if.Ecogenicidad</span>&nbsp;</p><p>Ecogenicidad endometrial: : EcogenicidadEndometrial <span class="mention svy-mention" data-mention="@endIf.Ecogenicidad" data-real-value="tb_pro_tto_to_tb_exp_mujer.ecogenici_lt" contenteditable="false" data-format="">@endIf.Ecogenicidad</span> <span class="mention svy-mention" data-mention="@if.Doppler" data-real-value="tb_pro_tto_to_tb_exp_mujer.doppler_lt" contenteditable="false" data-format="">@if.Doppler</span>&nbsp;</p><p>Doppler de la arteria uterina: : Doppler <span class="mention svy-mention" data-mention="@endIf.Doppler" data-real-value="tb_pro_tto_to_tb_exp_mujer.doppler_lt" contenteditable="false" data-format="">@endIf.Doppler</span> <span class="mention svy-mention" data-mention="@if.ComentarioEcografia" data-real-value="tb_pro_tto_to_tb_exp_mujer.eco_vc" contenteditable="false" data-format="">@if.ComentarioEcografia</span> &nbsp;</p><p>Comentarios: : Comments <span class="mention svy-mention" data-mention="@endIf.ComentarioEcografia" data-real-value="tb_pro_tto_to_tb_exp_mujer.eco_vc" contenteditable="false" data-format="">@endIf.ComentarioEcografia</span> <span class="mention svy-mention" data-mention="@if.AnaliticaHormonalCheck" data-real-value="rs_tb_pro_tto_to_tb_estimulacion.rs_tb_estimulacion_to_tb_estim_dia_contr.e2p4_q_valida" contenteditable="false" data-format="">@if.AnaliticaHormonalCheck</span>&nbsp;</p><h3>Analítica hormonal</h3><p>Estradiol: : Estradiol (ng/mL)</p><p>LH: : LH (UI/L)</p><p>Progesterona: : Progesterona (ng/mL) <span class="mention svy-mention" data-mention="@endIf.AnaliticaHormonalCheck" data-real-value="rs_tb_pro_tto_to_tb_estimulacion.rs_tb_estimulacion_to_tb_estim_dia_contr.e2p4_q_valida" contenteditable="false" data-format="">@endIf.AnaliticaHormonalCheck</span> <span class="mention svy-mention" data-mention="@if.TipoCiclo" data-real-value="t_ciclo_lt" contenteditable="false" data-format="">@if.TipoCiclo</span>&nbsp;</p><h3>Indicaciones</h3><p>Tras valoración ecográfica y conocer los resultados de la analítica, su médico se pondrá en contacto con usted para indicarle el siguiente paso. Es necesario que se encuentre disponible. Es posible que se requiera una nueva valoración ecográfica/analítica o que se programe la extracción del óvulo directamente.</p><p>La extracción del óvulo se hace, en principio, sin anestesia. Si la posición del ovario es adecuada, la punción de 1 folículo, sólo supone una ligera y breve molestia que desaparece inmediatamente. No aporta grandes ventajas la aplicación de una anestesia con sedación. Además, no implica un reposo posterior, ni siquiera la necesidad de la toma de analgésicos orales. No obstante, si el médico prevé una punción dificultosa o la paciente prefiere no notar nada, el acto puede hacerse con una sedación, y la paciente vendrá en ayunas. <span class="mention svy-mention" data-mention="@endIf.TipoCiclo" data-real-value="t_ciclo_lt" contenteditable="false" data-format="">@endIf.TipoCiclo</span> <span class="mention svy-mention" data-mention="@if.Cancelacion" data-real-value="c_rpt_vls_cancelac_mot_vc_L_Motivo_cancelacion" contenteditable="false" data-format="">@if.Cancelacion</span>&nbsp;</p><h4><strong>Cancelación de ciclo</strong></h4><p>El ciclo que se estaba realizando se ha cancelado por el siguiente motivo: &nbsp;<span class="mention svy-mention" data-mention="@endIf.Cancelacion" data-real-value="c_rpt_vls_cancelac_mot_vc_L_Motivo_cancelacion" contenteditable="false" data-format="">@endIf.Cancelacion</span> <span class="mention svy-mention" data-mention="@if.ProximaCita" data-real-value="tb_pro_tto_to_it2be_events_proxima_cita.fechacitasinhora_cl" contenteditable="false" data-format="">@if.ProximaCita</span> &nbsp;&nbsp;</p><h3>Próxima cita</h3><p>&nbsp; a las &nbsp;<span class="mention svy-mention" data-mention="@endIf.ProximaCita" data-real-value="tb_pro_tto_to_it2be_events_proxima_cita.fechacitasinhora_cl" contenteditable="false" data-format="">@endIf.ProximaCita</span> &nbsp;</p><h3>Firma</h3><p>Médico: &nbsp;</p><p>Nº. Colegiado: &nbsp;</p><p><span class="mention svy-mention" data-mention="@if.FirmaIMG" data-real-value="firma" contenteditable="false" data-format="">@if.FirmaIMG</span> <span class="mention svy-mention" data-mention="#Customer ID" data-real-value="customerid" contenteditable="false" data-format="">#Customer ID</span> &nbsp;<span class="mention svy-mention" data-mention="@endIf.FirmaIMG" data-real-value="firma" contenteditable="false" data-format="">@endIf.FirmaIMG</span>&nbsp;</p><p style="text-align:center;">&nbsp;</p>'

	var fs = datasources.db.example_data.customers.getFoundSet();
	if (fs.find()) {
		fs.customerid = 'SVYDO';
		fs.search()
	}
	var record = fs.getSelectedRecord()

	jsunit.assertNotNull(fs.getSelectedRecord())

	// if blocks all true
	var displayContent = scopes.svyDocEditor.mergeTags(content, record, ifcallbackTrue, mentionMergeIf);
	var expectedContent = '<h2 style="text-align:center;"><b> <i>Mention</i>: SVYDO</b></h2><p style="text-align:center;">Informe de control de ciclo (<b> <i>Mention</i>: SvyDocEditorCompany</b> )</p><p style="text-align:center;"></p><p style="text-align:center;"></p><p style="text-align:center;">Paciente:&nbsp;<strong> </strong></p><p style="text-align:center;">Pareja:&nbsp;<strong> </strong></p><p style="text-align:right;">Médico responsable: <strong><b> <i>Mention</i>: SvyDocEditorCompany</b> &nbsp;</strong></p><p style="text-align:right;">Coordinadora:  &nbsp;</p><p style="text-align:justify;">Se está realizando el siguiente tratamiento: . Con las siguientes especificaciones: </p><h3 style="text-align:justify;">Medicación previa</h3><p style="text-align:justify;">Deberá tomar los siguientes medicamentos siguiendo las instrucciones dadas por su médico. No modifique ni suspenda ninguna medicación sin consultárselo previamente.</p><p style="text-align:justify;"></p><p style="text-align:justify;"><strong>NombreMedicamento: </strong>desde : InicioToma. Dosis: : Dosis. Vía: : Via </p><p style="text-align:justify;"><strong>NombreMedicamento: </strong>desde : InicioToma. Dosis: : Dosis. Vía: : Via  </p><p style="text-align:justify;">&nbsp;</p><p style="text-align:justify;">Paciente que acude a consulta para valoración ecográfica y realización de analítica hormonal dentro del protocolo de ciclo natural. Test de ovulación positivo el día <span style="color:#abb2bf;">_______________.  </span></p><h4><strong>Medicación larga duración</strong></h4><p>Deberá tomar los siguientes medicamentos siguiendo las instrucciones dadas por su médico. No modifique ni suspenda ninguna medicación sin consultárselo previamente.</p><figure class="table"><table><thead><tr><th style="background-color:hsl(0, 0%, 100%);text-align:center;">&nbsp;</th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Lunes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Martes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Miércoles</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Jueves</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Viernes</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Sábado</strong></span></th><th style="background-color:#d9272e;text-align:center;"><span class="text-small" style="color:hsl(0,0%,100%);"><strong>Domingo</strong></span></th></tr></thead><tbody><tr><td style="text-align:center;">&nbsp;</td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">21 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">22 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">23 &nbsp;mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">24 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">25 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">26 mar.</span></td><td style="background-color:#f8d8da;border:1pt solid hsl(0, 0%, 0%);text-align:center;"><span class="text-small">27 mar.</span></td></tr><tr><td style="background-color:#f8d8da;border-color:hsl(0, 0%, 0%);border-style:solid;text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td><td style="text-align:center;"><ul><li>Antic 1</li><li>Zitro 1</li></ul></td></tr><tr><td style="background-color:#f8d8da;border-color:hsl(0, 0%, 0%);border-style:solid;text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td><td style="text-align:center;">&nbsp;</td></tr></tbody></table></figure><h4><strong>Calendario de medicación</strong></h4><p>Si el tratamiento sufre alguna modificación, su médico se lo especificará posteriormente.</p><p>La programación del ciclo es provisional, se fijará la fecha en función de la siguiente menstruación, normalmente se comienza el día 3º de ciclo, considerando el primer día de ciclo como primer día de menstruación normal</p><figure class="table"><table><tbody><tr><th style="background-color:#f8d8da;"><strong>Día tto.</strong></th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">Día&nbsp;</th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">&nbsp;</th><td>&nbsp;</td></tr></tbody></table></figure><p style="text-align:justify;">La administración de los medicamentos debe de realizarse todos los días a la misma hora, recomendamos la última hora de la tarde para que cuando comience con los controles sea tras los mismos. En el caso que se indique administraciones mañana y tarde debe de procurar que haya 12 horas de separación.</p><p style="text-align:justify;">&nbsp;</p><h4><strong>Control ecográfico </strong></h4><p>Número y tamaño de los folículos del ovario derecho: : OD  </p><p>Número y tamaño de los folículos del ovario izquierdo: : OI  </p><p>Grosor endometrial: : GrosorEndometrial  </p><p>Ecogenicidad endometrial: : EcogenicidadEndometrial  </p><p>Doppler de la arteria uterina: : Doppler  </p><p>Comentarios: : Comments  </p><h3>Analítica hormonal</h3><p>Estradiol: : Estradiol (ng/mL)</p><p>LH: : LH (UI/L)</p><p>Progesterona: : Progesterona (ng/mL)  </p><h3>Indicaciones</h3><p>Tras valoración ecográfica y conocer los resultados de la analítica, su médico se pondrá en contacto con usted para indicarle el siguiente paso. Es necesario que se encuentre disponible. Es posible que se requiera una nueva valoración ecográfica/analítica o que se programe la extracción del óvulo directamente.</p><p>La extracción del óvulo se hace, en principio, sin anestesia. Si la posición del ovario es adecuada, la punción de 1 folículo, sólo supone una ligera y breve molestia que desaparece inmediatamente. No aporta grandes ventajas la aplicación de una anestesia con sedación. Además, no implica un reposo posterior, ni siquiera la necesidad de la toma de analgésicos orales. No obstante, si el médico prevé una punción dificultosa o la paciente prefiere no notar nada, el acto puede hacerse con una sedación, y la paciente vendrá en ayunas.  </p><h4><strong>Cancelación de ciclo</strong></h4><p>El ciclo que se estaba realizando se ha cancelado por el siguiente motivo: &nbsp; </p><h3>Próxima cita</h3><p>&nbsp; a las &nbsp; &nbsp;</p><h3>Firma</h3><p>Médico: &nbsp;</p><p>Nº. Colegiado: &nbsp;</p><p><b> <i>Mention</i>: SVYDO</b> &nbsp;</p><p style="text-align:center;">&nbsp;</p>'
	jsunit.assertEquals(expectedContent, displayContent)

	// if blocks all false
	displayContent = scopes.svyDocEditor.mergeTags(content, record, ifcallbackFalse, mentionMergeIf);
	expectedContent = '<h2 style="text-align:center;"><b> <i>Mention</i>: SVYDO</b></h2><p style="text-align:center;">Informe de control de ciclo (<b> <i>Mention</i>: SvyDocEditorCompany</b> )</p><p style="text-align:center;"></p><p style="text-align:center;">Paciente:&nbsp;<strong> </strong></p><p style="text-align:right;">Médico responsable: <strong><b> <i>Mention</i>: SvyDocEditorCompany</b> &nbsp;</strong> &nbsp;</p><p style="text-align:justify;">Se está realizando el siguiente tratamiento: . Con las siguientes especificaciones:   </p><h4><strong>Calendario de medicación</strong></h4><p>Si el tratamiento sufre alguna modificación, su médico se lo especificará posteriormente.</p><p>La programación del ciclo es provisional, se fijará la fecha en función de la siguiente menstruación, normalmente se comienza el día 3º de ciclo, considerando el primer día de ciclo como primer día de menstruación normal</p><figure class="table"><table><tbody><tr><th style="background-color:#f8d8da;"><strong>Día tto.</strong></th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">Día&nbsp;</th><td><p style="text-align:center;">&nbsp;</p></td></tr><tr><th style="background-color:#f8d8da;">&nbsp;</th><td>&nbsp;</td></tr></tbody></table></figure><p style="text-align:justify;">La administración de los medicamentos debe de realizarse todos los días a la misma hora, recomendamos la última hora de la tarde para que cuando comience con los controles sea tras los mismos. En el caso que se indique administraciones mañana y tarde debe de procurar que haya 12 horas de separación.</p><p style="text-align:justify;">&nbsp;</p><h4><strong>Control ecográfico           &nbsp;</p><h3>Firma</h3><p>Médico: &nbsp;</p><p>Nº. Colegiado: &nbsp;</p><p style="text-align:center;">&nbsp;</p>'
	jsunit.assertEquals(expectedContent, displayContent)

	// different content
	content = '<h2>CUSTOMER: <span class="mention svy-mention" data-mention="#Customer ID" data-real-value="customerid" contenteditable="false" data-format="">#Customer ID</span>&nbsp;</h2><p><span class="mention svy-mention" data-mention="$startRepeater.Orders" data-real-value="startRepeater-customers_to_orders" contenteditable="false" data-format="">$startRepeater.Orders</span>&nbsp;</p><h2>ORDER: <span class="mention svy-mention" data-mention="#orders.Order ID" data-real-value="customers_to_orders.orderid" contenteditable="false" data-format="">#orders.Order ID</span>&nbsp;</h2><p>StartIFVIA <span class="mention svy-mention" data-mention="@if.Via" data-real-value="shipvia" contenteditable="false" data-format="">@if.Via</span>&nbsp;</p><p>VAI VIAAAA</p><p><span class="mention svy-mention" data-mention="@endIf.Via" data-real-value="shipvia" contenteditable="false" data-format="">@endIf.Via</span> EndIFVia</p><p>StartIFreight<span class="mention svy-mention" data-mention="@if.DisFreight" data-real-value="freight" contenteditable="false" data-format="">@if.DisFreight</span>&nbsp;</p><p>CONTENT: FREIGHT</p><p><span class="mention svy-mention" data-mention="@endIf.DisFreight" data-real-value="freight" contenteditable="false" data-format="">@endIf.DisFreight</span>EndIFreight</p><p>ST1<span class="mention svy-mention" data-mention="@if.T1" data-real-value="test1" contenteditable="false" data-format="">@if.T1</span></p><p>CONTENT TEST1</p><p><span class="mention svy-mention" data-mention="@endIf.T1" data-real-value="test1" contenteditable="false" data-format="">@endIf.T1</span>ET1</p><p>ST2<span class="mention svy-mention" data-mention="@if.T2" data-real-value="test2" contenteditable="false" data-format="">@if.T2</span>&nbsp;</p><p>CONTENT T2</p><p>…………………………..</p><p>ST1<span class="mention svy-mention" data-mention="@if.T1" data-real-value="test1" contenteditable="false" data-format="">@if.T1</span>&nbsp;</p><p>Content T2 Nested T1</p><p><span class="mention svy-mention" data-mention="@endIf.T1" data-real-value="test1" contenteditable="false" data-format="">@endIf.T1</span>&nbsp;</p><p>more of T2</p><p><span class="mention svy-mention" data-mention="@endIf.T2" data-real-value="test2" contenteditable="false" data-format="">@endIf.T2</span>ET2</p><h2>TABLE</h2><p><span class="mention svy-mention" data-mention="$startRepeater.OrderDetails" data-real-value="startRepeater-orders_to_order_details" contenteditable="false" data-format="">$startRepeater.OrderDetails</span>&nbsp;</p><p>ORDER LINES: <span class="mention svy-mention" data-mention="#orders.Order ID" data-real-value="customers_to_orders.orderid" contenteditable="false" data-format="">#orders.Order ID</span> - <span class="mention svy-mention" data-mention="#Product.Name" data-real-value="customers_to_orders.orders_to_order_details.order_details_to_products.productname" contenteditable="false" data-format="">#Product.Name</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="@if.Via" data-real-value="shipvia" contenteditable="false" data-format="">@if.Via</span>&nbsp;</p><p>Quantity: <span class="mention svy-mention" data-mention="#OrderDetails.Quantity" data-real-value="orders_to_order_details.quantity" contenteditable="false" data-format="">#OrderDetails.Quantity</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="@endIf.Via" data-real-value="shipvia" contenteditable="false" data-format="">@endIf.Via</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="@if.T1" data-real-value="test1" contenteditable="false" data-format="">@if.T1</span>&nbsp;</p><p>PRICE: <span class="mention svy-mention" data-mention="#OrderDetails.Unit Price" data-real-value="orders_to_order_details.unitprice" contenteditable="false" data-format="">#OrderDetails.Unit Price</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="@endIf.T1" data-real-value="test1" contenteditable="false" data-format="">@endIf.T1</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="$endRepeater" data-real-value="endRepeater" contenteditable="false" data-format="">$endRepeater</span></p><p>END OF SUBORDERS&gt;&gt;&gt;&gt;</p><p><span class="mention svy-mention" data-mention="$endRepeater" data-real-value="endRepeater" contenteditable="false" data-format="">$endRepeater</span>&nbsp;</p><h2>MYCLASS ? Intrauterine Artificial Insemination Cycle Report</h2><p>Patient: <span class="mention svy-mention" data-mention="#NombrePaciente" data-real-value="nombrepaciente" contenteditable="false" data-format="">#NombrePaciente</span></p><p><span class="mention svy-mention" data-mention="@if.NombreParejaPaciente" data-real-value="nombreparejapaciente" contenteditable="false" data-format="">@if.NombreParejaPaciente</span></p><p>Partner: <span class="mention svy-mention" data-mention="#NombreParejaPaciente" data-real-value="nombreparejapaciente" contenteditable="false" data-format="">#NombreParejaPaciente</span> <span class="mention svy-mention" data-mention="@endIf.NombreParejaPaciente" data-real-value="NombreParejaPaciente" contenteditable="false" data-format="">@endIf.NombreParejaPaciente</span> &nbsp;&nbsp;</p><h3><strong>Sperm sample details</strong></h3><p>Type of sample: <span class="mention svy-mention" data-mention="#OrigenMuestra" data-real-value="patient_to_insemination.origenmuestra" contenteditable="false" data-format="">#OrigenMuestra</span> &nbsp;</p><p><span class="mention svy-mention" data-mention="@if.OrigenMuestra" data-real-value="origenmuestra" contenteditable="false" data-format="">@if.OrigenMuestra</span></p><p>Blood group and Rh Factor: <span class="mention svy-mention" data-mention="#GrupoRH" data-real-value="gruporh" contenteditable="false" data-format="">#GrupoRH</span></p><p>Sample volume: <span class="mention svy-mention" data-mention="#VolumenMuestra" data-real-value="patient_to_insemination.volumenmuestra" contenteditable="false" data-format="">#VolumenMuestra</span> &nbsp;mL</p><p>Sperm concentration: <span class="mention svy-mention" data-mention="#ConcentracionEspermatoziodesFr" data-real-value="patient_to_insemination.concentracionespermatoziodesfr" contenteditable="false" data-format="">#ConcentracionEspermatoziodesFr</span> &nbsp;mill/ml</p><p>Progressive motile sperm: <span class="mention svy-mention" data-mention="#SpzMovilesProgresivosFr" data-real-value="patient_to_insemination.spzmovilesprogresivosfr" contenteditable="false" data-format="">#SpzMovilesProgresivosFr</span> &nbsp;%</p><p>Capacitation method: <span class="mention svy-mention" data-mention="#MetodoCapacitacion" data-real-value="patient_to_insemination.metodocapacitacion" contenteditable="false" data-format="">#MetodoCapacitacion</span>&nbsp;</p><p>Sperm concentration after capacitation: <span class="mention svy-mention" data-mention="#ConcentracionEspermatoziodesTrasCapacitacion" data-real-value="patient_to_insemination.concentracionespermatoziodestrascapacitacion" contenteditable="false" data-format="">#ConcentracionEspermatoziodesTrasCapacitacion</span> &nbsp;mill/ml</p><p>Progressive motile sperm after capacitation: <span class="mention svy-mention" data-mention="#SpzMovilesProgresivosTrasCapacitacion" data-real-value="patient_to_insemination.spzmovilesprogresivostrascapacitacion" contenteditable="false" data-format="">#SpzMovilesProgresivosTrasCapacitacion</span> &nbsp;%</p><h4><strong>Insemination details</strong>&nbsp;</h4><p>Date of insemination.: <span class="mention svy-mention" data-mention="#FechaInseminacion" data-real-value="patient_to_insemination.fechainseminacion" contenteditable="false" data-format="">#FechaInseminacion</span>&nbsp;</p><p><span class="mention svy-mention" data-mention="@endIf" data-real-value="endIf" contenteditable="false" data-format="">@endIf</span></p><p>Gynaecologist: <span class="mention svy-mention" data-mention="#Ginecologo" data-real-value="patients_to_users.ginecologo" contenteditable="false" data-format="">#Ginecologo</span>&nbsp;</p><p>Biologist: <span class="mention svy-mention" data-mention="#Biologo" data-real-value="patient_to_user.biologo" contenteditable="false" data-format="">#Biologo</span>&nbsp;</p><p>Insemination volume (ml): <span class="mention svy-mention" data-mention="#VolumenInseminacion" data-real-value="patient_to_insemination.volumeninseminacion" contenteditable="false" data-format="">#VolumenInseminacion</span>&nbsp;</p><p>Total count of motile x: <span class="mention svy-mention" data-mention="#REMInseminado" data-real-value="patient_to_insemination.reminseminado" contenteditable="false" data-format="">#REMInseminado</span>&nbsp;</p><h4><strong>Recommendations&nbsp;</strong><br><br>The team at x wishes you the best of luck.<br><br>&nbsp;</h4>'

	displayContent = scopes.svyDocEditor.mergeTags(content, record, ifcallbackTrue, mentionMergeIf);
	expectedContent = '<h2>CUSTOMER: <b> <i>Mention</i>: SVYDO</b></h2><h2>ORDER: <b> <i>Mention</i>: 999910</b></h2><p>StartIFVIA </p><p>VAI VIAAAA</p><p> EndIFVia</p><p>StartIFreight</p><p>CONTENT: FREIGHT</p><p>EndIFreight</p><p>ST1</p><p>CONTENT TEST1</p><p>ET1</p><p>ST2</p><p>CONTENT T2</p><p>…………………………..</p><p>ST1</p><p>Content T2 Nested T1</p><p>more of T2</p><p>ET2</p><h2>TABLE</h2><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b> <i>Mention</i>: Northwoods Cranberry Sauce</b></p><p>Quantity: <b> <i>Mention</i>: 12</b></p><p>PRICE: <b> <i>Mention</i>: 14</b></p><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b><i> -empty productname</i></b></p><p>Quantity: <b> <i>Mention</i>: 12</b></p><p>PRICE: <b> <i>Mention</i>: 14</b></p><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b><i> -empty productname</i></b></p><p>Quantity: <b> <i>Mention</i>: 12</b></p><p>PRICE: <b> <i>Mention</i>: 14</b></p><p>END OF SUBORDERS&gt;&gt;&gt;&gt;</p><h2>ORDER: <b> <i>Mention</i>: 999911</b></h2><p>StartIFVIA </p><p>VAI VIAAAA</p><p> EndIFVia</p><p>StartIFreight</p><p>CONTENT: FREIGHT</p><p>EndIFreight</p><p>ST1</p><p>CONTENT TEST1</p><p>ET1</p><p>ST2</p><p>CONTENT T2</p><p>…………………………..</p><p>ST1</p><p>Content T2 Nested T1</p><p>more of T2</p><p>ET2</p><h2>TABLE</h2><p>ORDER LINES: <b> <i>Mention</i>: 999911</b> - <b> <i>Mention</i>: Mishi Kobe Niku</b></p><p>Quantity: <b> <i>Mention</i>: 12</b></p><p>PRICE: <b> <i>Mention</i>: 14</b></p><p>ORDER LINES: <b> <i>Mention</i>: 999911</b> - <b><i> -empty productname</i></b></p><p>Quantity: <b> <i>Mention</i>: 12</b></p><p>PRICE: <b> <i>Mention</i>: 14</b></p><p>END OF SUBORDERS&gt;&gt;&gt;&gt;</p><h2>MYCLASS ? Intrauterine Artificial Insemination Cycle Report</h2><p>Patient: <b><i> -empty nombrepaciente</i></b></p><p>Partner: <b><i> -empty nombreparejapaciente</i></b>  &nbsp;&nbsp;</p><h3><strong>Sperm sample details</strong></h3><p>Type of sample: <b><i> -empty origenmuestra</i></b> &nbsp;</p><p>Blood group and Rh Factor: <b><i> -empty gruporh</i></b></p><p>Sample volume: <b><i> -empty volumenmuestra</i></b> &nbsp;mL</p><p>Sperm concentration: <b><i> -empty concentracionespermatoziodesfr</i></b> &nbsp;mill/ml</p><p>Progressive motile sperm: <b><i> -empty spzmovilesprogresivosfr</i></b> &nbsp;%</p><p>Capacitation method: <b><i> -empty metodocapacitacion</i></b></p><p>Sperm concentration after capacitation: <b><i> -empty concentracionespermatoziodestrascapacitacion</i></b> &nbsp;mill/ml</p><p>Progressive motile sperm after capacitation: <b><i> -empty spzmovilesprogresivostrascapacitacion</i></b> &nbsp;%</p><h4><strong>Insemination details</strong>&nbsp;</h4><p>Date of insemination.: <b><i> -empty fechainseminacion</i></b></p><p>Gynaecologist: <b><i> -empty ginecologo</i></b></p><p>Biologist: <b><i> -empty biologo</i></b></p><p>Insemination volume (ml): <b><i> -empty volumeninseminacion</i></b></p><p>Total count of motile x: <b><i> -empty reminseminado</i></b></p><h4><strong>Recommendations&nbsp;</strong><br><br>The team at x wishes you the best of luck.<br><br>&nbsp;</h4>'
	jsunit.assertEquals(expectedContent, displayContent);
	
	displayContent = scopes.svyDocEditor.mergeTags(content, record, ifcallbackFalse, mentionMergeIf);
	expectedContent = '<h2>CUSTOMER: <b> <i>Mention</i>: SVYDO</b></h2><h2>ORDER: <b> <i>Mention</i>: 999910</b></h2><p>StartIFVIA  EndIFVia</p><p>StartIFreightEndIFreight</p><p>ST1ET1</p><p>ST2ET2</p><h2>TABLE</h2><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b> <i>Mention</i>: Northwoods Cranberry Sauce</b></p><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b><i> -empty productname</i></b></p><p>ORDER LINES: <b> <i>Mention</i>: 999910</b> - <b><i> -empty productname</i></b></p><p>END OF SUBORDERS&gt;&gt;&gt;&gt;</p><h2>ORDER: <b> <i>Mention</i>: 999911</b></h2><p>StartIFVIA  EndIFVia</p><p>StartIFreightEndIFreight</p><p>ST1ET1</p><p>ST2ET2</p><h2>TABLE</h2><p>ORDER LINES: <b> <i>Mention</i>: 999911</b> - <b> <i>Mention</i>: Mishi Kobe Niku</b></p><p>ORDER LINES: <b> <i>Mention</i>: 999911</b> - <b><i> -empty productname</i></b></p><p>END OF SUBORDERS&gt;&gt;&gt;&gt;</p><h2>MYCLASS ? Intrauterine Artificial Insemination Cycle Report</h2><p>Patient: <b><i> -empty nombrepaciente</i></b></p><p> &nbsp;&nbsp;</p><h3><strong>Sperm sample details</strong></h3><p>Type of sample: <b><i> -empty origenmuestra</i></b> &nbsp;</p><p>Gynaecologist: <b><i> -empty ginecologo</i></b></p><p>Biologist: <b><i> -empty biologo</i></b></p><p>Insemination volume (ml): <b><i> -empty volumeninseminacion</i></b></p><p>Total count of motile x: <b><i> -empty reminseminado</i></b></p><h4><strong>Recommendations&nbsp;</strong><br><br>The team at x wishes you the best of luck.<br><br>&nbsp;</h4>'
	jsunit.assertEquals(expectedContent, displayContent);

}

/**
 * @param {String} mentionRealValue
 * @param {JSRecord} record
 *
 * @return {Boolean}
 * @properties={typeid:24,uuid:"51DDD481-F981-4624-A758-BD5D56A14BF5"}
 */
function ifcallbackMergeIf(mentionRealValue, record) {

	switch (mentionRealValue) {
	case 'x':
		return true
		break;
	default:
		break;
	}

	return true
}

/**
 * @param mentionRealValue
 * @param record
 *
 * @return {Boolean}
 *
 * @properties={typeid:24,uuid:"777EF5D5-492C-42E7-8D59-283EF0D3E691"}
 */
function ifcallbackFalse(mentionRealValue, record) {
	return false
}

/**
 * @param mentionRealValue
 * @param record
 *
 * @return {Boolean}
 *
 * @properties={typeid:24,uuid:"3A81D398-865A-4D8D-B421-BBF84A51E093"}
 */
function ifcallbackTrue(mentionRealValue, record) {
	return true
}

/**
 * @return String
 * @properties={typeid:24,uuid:"06F34415-571F-4235-A4C1-1AB1FD3ADC2A"}
 */
function mentionMergeIf(mentionRealValue, mentionDisplayValue, dataProvider, relationName, record) {
	return record && record[dataProvider] ? '<b> <i>Mention</i>: ' + record[dataProvider] + '</b>' : '<b><i> -empty ' + dataProvider + '</i></b>';
}
